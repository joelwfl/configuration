(function(c){var Q,F,G,H,R,S,I,T,U,V,W,J,X,Y,Z,$,aa,K;function ma(){var a=window.innerHeight,d=document.compatMode;if(d||!c.support.boxModel)a="CSS1Compat"==d?document.documentElement.clientHeight:document.body.clientHeight;return a}function na(a,d){var b=setInterval(function(){var k=ma(),e=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop;c(a).each(function(){var a=c(this),g=a.offset().top,h=a.height(),i=a.data("inview")||!1;e>g+h||e+k<g?i&&a.data("inview",
!1):e<g+h&&!i&&(console.log(e,g,h,g+h),a.data("inview",!0),clearInterval(b),d())})},750)}function ba(a){c(Q,e).html(a);c(F,e).css("visibility","visible");setTimeout(oa,5E3)}function oa(){c(F,e).css("visibility","hidden")}function p(){chrome.extension.sendRequest({action:"track",track:arguments})}function ca(a){chrome.extension.sendRequest({action:"trackPageview",track:a})}function pa(){var a=c,d='<div data-eid="'+q+'" class="'+G+' anydo-tour"><h2>'+b("gmail_tour_title")+"</h2>",m;m="<p>"+b("gmail_tour").replace(/\n{2,}/g,
"</p><p>").replace(/\n/g,"<br>")+"</p>";u=a(d+m+"<footer></footer></div>");u.insertAfter(n);a=da()+2;u.css("left",a+"px").show();n.addClass("anydo-tour-on");L=!1}function M(a){if(3===a.nodeType)return a.textContent;if("BR"==a.nodeName)return"\n";var d=c.map(a.childNodes,M),a={block:"\n","inline-block":"\n","table-row":"\n","table-cell":"\t"}[getComputedStyle(a).display]||"";return d.join("")+a}function qa(){var a=/#.*\/([0-9a-f]{16})$/.exec(window.location.hash);return a?a[1]:null}function ra(a){return Date.parse(a.replace("at ",
""))}function ea(){return Sha1.hash(""+c(H,e).attr("title")+">:<"+o().originalTitle)}function sa(){if(null!==qa()){for(var a=c(R,e),d=o().originalTitle,b=c(S).text(),a=a.map(function(a,e){var k=c(I,e),i=c(T,e),h=c(H,e),g=c(U,e),f=M(g[0]),j=c('img[src="images/cleardot.gif"]',g);if(0<j.length){var f=Sha1.hash(f),t=c('<div style="display:none">'+f+"</div>");j.after(t);g=M(g[0]);f=g.substr(0,g.search(f));t.remove()}i=i.map(function(a,d){var b=c(d);return{email:b.attr("email"),name:b.text()}});t=k.attr("email");
return t.toLowerCase()===b.toLowerCase()?null:{sender:{name:k.text(),email:t},recipients:i,date:ra(h.attr("title")),subject:d,body:f}}),k=ea(),h=JSON.parse(localStorage.getItem(k)||"{}"),j=[],g=0;g<a.length;g++)for(var f=c.task_extractor.extract_tasks(a[g]),i=0;i<f.length;i++)h.hasOwnProperty(f[i][0])?console.log(k+" already seen: "+f[i]):(j.push(f[i]),c.post("http://afternoon-earth-1266.herokuapp.com/raw_email_analytics",{suggestion:f[i][0],original:f[i][1],conversation:k}));j.conversation=k;return j}}
function ta(a){var d=c(V,e).last(),m='<div class="gA gt ac5 anydo-anybar" data-eid="'+q+'"><div class="gB"><div class="iq"><table class="cf FVrZGe"><tbody>            <tr><td class="amq"><img src="'+v("images/anydo-profile.png")+'" class="ajn bofPge"></td>            <td class="amr"><strong>What\'s Next?</strong><input class="bar-input" type="text" value="<% text %>" data-placeholder="<% followup_example %>" placeholder="<% followup_followUpPlaceholder %>">            <div class="suggestion-controls">                <span class="suggestion-container">                <a href="#" class="suggestion-add suggestion-date-category category-today" data-category="TODAY">'+
b("x_date_today")+'</a>                    <div class="reminder-choices-popup">                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="09:00:00">'+b("x_9am")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="12:00:00">'+b("x_12pm")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="20:00:00">'+b("x_8pm")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder custom">'+
b("date_custom")+'</a>                    </div>                    <div class="reminder-choices-popup customReminderPicker">                    <iframe class="calendarFrame"></iframe>                    <a class="anydo-setCustomReminder suggestion-add" href="#">SET</a>                    </div>                </span>                <span class="suggestion-container">                <a href="#" class="suggestion-add suggestion-date-category" data-category="TOMORROW">'+b("x_date_tomorrow")+'</a>                    <div class="reminder-choices-popup">                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="09:00:00">'+
b("x_9am")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="12:00:00">'+b("x_12pm")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="20:00:00">'+b("x_8pm")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder custom">'+b("x_date_custom")+'</a>                    </div>                </span>                <span class="suggestion-container">                <a href="#" class="suggestion-add suggestion-date-category" data-category="UPCOMING">'+
b("x_later")+'</a>                    <div class="reminder-choices-popup">                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="7">'+b("x_date_1_week")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="14">'+b("x_date_2_weeks")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder" data-reminder="30">'+b("x_date_1_month")+'</a>                    <a href="#" class="suggestion-add suggestion-reminder custom">'+
b("x_date_custom")+"</a>                    </div>                </span>            </div>            </td></tr></tbody></table></div></div></div>",k=!1;0==a.length&&(a[0]=[""],k=!0);var f=0,j=document.location.href,g=o(),g=g.followUpName?b("x_followup_with",g.followUpName):b("x_followup_on",g.originalTitle),l=b("x_followup_placeholder",g),i=c(m.replace("<% text %>",a[f][0]).replace("<% followup_example %>",g).replace("<% followup_followUpPlaceholder %>",l));d.before(i);c(".bar-input",i).css({"border-style":"solid",
"border-color":"#ABADB3","border-width":"1px"});na(d,function(){setTimeout(function(){k||c(".bar-input",i).animate({"background-color":"rgba(251, 255, 161, 1.0)"},300).animate({"background-color":"rgba(251, 255, 161, 0.0)"},300)},100)});N=c(".customReminderPicker .calendarFrame",e);N.attr("src",z+"#inAnybar=true");L&&pa();i.on("click",".suggestion-add",function(d){d.preventDefault();d=c(d.target);c(this).parents(".reminder-choices-popup").addClass("invisible");var b=i.find(".bar-input").val()||i.find(".bar-input").data("placeholder"),
m={title:b,linkUrl:j,conversation:a.conversation};console.log(a,m);var k="DATE_CATEGORY_TODAY";d.data("category")&&(k="DATE_CATEGORY_"+d.data("category"));if(d.hasClass("suggestion-reminder")){k=d.parents(".suggestion-container").children(".suggestion-date-category").data("category");h=w[k]();d.data("reminder")&&fa(d.data("reminder"),h);k=h;m.alert=r}if(d.hasClass("custom")){console.log(d,d.parent());N.attr("src",z.replace(/(#.+)?$/,"#"+h+"&inAnybar=true"));c(".customReminderPicker",e).insertAfter(d.parent()).addClass("visible")}else{var g=
"";console.log("add task: "+b);if(f<a.length){var l=a[f][0];console.log("original suggestion: "+l);m.originalSuggestion=l;var l=ea(),n=JSON.parse(localStorage.getItem(l)||"{}");n[b]=true;localStorage.setItem(l,JSON.stringify(n));f++;f<a.length&&(g=a[f][0])}i.find(".bar-input").val(g);p("Gmail","Actionbar Task Added");if(d.hasClass("anydo-setCustomReminder")){k=h;m.alert=r}console.log("adding task with details",m,k);ga({type:"gmailAddTask",data:m,dateCategory:k})}});var n=d.parent().children().first();
d.parent().on("click",function(){setTimeout(function(){var d=n.is(":visible");i.toggle(d)},300)})}function ga(a){chrome.extension.sendMessage(a,function(d){console.log("got response",d);d.success?ba(b("task_added",['<a href="javascript:;" class="anydo-open-popup ad SL7K4c" data-eid="'+q+'" tabindex="0">Any.DO</a>'])):"loggedOut"===d.errorReason&&ba(b("error_must_login_first"))})}function x(a,d){ga({type:"gmailAddTask",data:{title:a.inputTitle,linkUrl:a.url,alert:r},dateCategory:d})}function o(){var a=
{originalTitle:c(W,e).text(),inputTitle:l.val(),fromName:c(J,e).attr("name").split(" ")[0],fromEmail:c(J,e).attr("email"),url:document.location.href},d=c(I,e).map(function(d,a){return c(a).attr("name")}).filter(function(d,a){return a!==c(X,e).text()}),b=d.length;a.followUpName=b?d[b-1].split(" ")[0]:null;a.taskTitle=a.originalTitle+" (from "+a.fromName+")";return a}function A(a,d){d=d||new Date;d.setSeconds(0);d.setDate(d.getDate()+a);d.setMinutes(5*parseInt(d.getMinutes()/5));return+d+""}function da(){var a=
c.isWindow,d;c.isWindow=function(){return!0};d=n.position().left;c.isWindow=a;return d}function ua(){var a=c(Y,e);if(void 0===a.data("anydo_marker")){a.data("anydo_marker","anydo");var d=c(B+":visible",e),m=c(Z,e);chrome.extension.sendMessage({type:"isGmailActive"},function(a){if(a){if(!d.length&&m.length){var a=m.find($),h="<div data-eid='"+q+"' class='"+(aa+" anydo-button")+"' data-tooltip='"+b("add_this_thread")+"' style='padding-left: 16px; padding-right: 16px;'>                                <div aria-haspopup='true' style='-webkit-user-select: none; margin-bottom:0px;margin-top:-2px; outline: none;' role='button' class='J-J5-Ji W6eDmd L3 J-Zh-I J-J5-Ji Bq L3' tabindex='0'>                                     <img class='f tk3N6e-I-J3' src='"+
v("icons/anydo-gmail-local.png")+"' style='vertical-align: -3px; height: 13px;'/> <span class='anydo-button-text'>"+b("remind_me")+"</span> <div class='G-asx T-I-J3 J-J5-Ji'>&nbsp;</div></div>                                </div>                           ",o="<div data-eid='"+q+"' class='"+(G+" anydo-menu")+"' style='display: none; position: absolute; min-width: 278px; -webkit-user-select: none; overflow: hidden;'>                            <div class='menuInnerContainer' style='position: relative; left: 0;'>                            <div class='SK AX' style='-webkit-user-select: none;'>                                <h2>"+
b("add_to_my_anydo")+"</h2>                                 <span style='margin-left: 15px; color: #8e8e8e; font-size: 15px;'>"+b("gmail_task_title_label")+"</span> <div class='J-M-JJ asg' style='border: none; display: inline-block; padding: 0; margin: 11px 0 17px; width: 80%; max-width: 225px;'>                                     <input class='anydo-input-title' style='color: #000; font-style: italic; font-size: 14px; padding: 6px 7px; border: 1px solid #ddd; width: 92%;'>                                 </div>                                 <div class='J-Kh' style='-webkit-user-select: none; margin: -3px 4px 0; padding-top: 3px; border-top-color: #e1e1e1;'></div>                                <% items %>                            </div>                            <div class='reminderPanel' style='display: none;'><iframe class='calendarFrame'></iframe>                                <a class='anydo-back' href='#'>"+
b("back")+"</a>                                <a class='anydo-setReminder' href='#'>"+b("set")+"</a>                            </div>                            </div>                        </div>";n=c(h);var g="";c.each(ha,function(a,d){g+="<div class='J-N anydo-item <% classNames %>' role='menuitem' data-id='<% id %>' style='-webkit-user-select: none; <% css %>'><% text %><span class='remind'><% reminderLinks %></span></div>".replace(/<% text %>/,d.text).replace(/<% id %>/,a).replace(/<% reminderLinks %>/,
d.reminderLinks||"").replace(/<% classNames %>/,d.classNames||"").replace(/<% css %>/,d.css||"")});o=o.replace(/<% items %>/,g);j=c(o);a.filter(":last").append(n.add(j));s=c(f+" .reminderPanel",e);C=c(f+" .menuInnerContainer",e);O=s.find(".calendarFrame");l=c(f+" .anydo-input-title",e);P=l.parent();O.attr("src",z);ca("/gmail-thread");a=sa();ta(a);0==a.length?console.log("no tasks detected!"):p("Gmail","Suggested",""+a.length)}}else c(e).find(B+","+f+","+ia).remove()})}}function ja(){u&&(u.remove(),
n.removeClass("anydo-tour-on"))}function y(){j&&(n.removeClass(K),j.removeClass("open").hide(),j.css({width:D,height:E}),C.css("left",0),s.hide(),h=null,r={type:"NONE"})}function fa(a,d){if(-1<a.toString().indexOf(":"))h=new Date(+d),h.setHours.apply(h,a.split(":").map(parseFloat)),h=+h;else{var c=864E5*+a,d=new Date;d.setHours(9);d.setMinutes(0);d.setSeconds(0);h=+d+c}r={customTime:0,offset:0,type:"OFFSET"}}function ka(a){c(a).each(function(a,b){b=c(b);b.data("reminder").split(":")[0]<(new Date).getHours()?
b.addClass("pastTime"):b.removeClass("pastTime")})}var L=!1,v=chrome.extension.getURL,b=chrome.i18n.getMessage,e=c(document),la=c("body",e),n,j,D,E,s,C,u,h,r,l,P,O,z=v("calendar.html"),N,q=b("@@extension_id"),B=".anydo-button[data-eid="+q+"]",f=".anydo-menu[data-eid="+q+"]",ia=".anydo-tour[data-eid="+q+"]";c('<link rel="stylesheet">').attr("href",v("css/gmail.css?v=")+Math.random()).appendTo(la);c('<link rel="stylesheet">').attr("href",v("css/pfdindisplaypro-inline.css")).appendTo(la);chrome.extension.sendMessage({type:"gmailInit"},
function(a){L=a.tour});Z=".iH[gh=mtb]";W=".hP:visible";J=".gD";aa="T-I J-J5-Ji ar7 nf T-I-ax7 L3";K="T-I-Kq";G="J-M jQjAxd";F=".b8.UC";Q=".b8.UC .vh";$=".G-Ni.J-J5-Ji";R=".h7:visible";Y=".h7.ie";I=".gD";T=".g2";H=".g3";U=".ii.gt.adP.adO";V=".gA.gt";S="[aria-owns=gbd4]";X="#gbmpn";var w={TODAY:function(){return A(0)},TOMORROW:function(){return A(1)},UPCOMING:function(){return A(2)},SOMEDAY:function(){return A(8)}},ha=[{text:b("date_today"),category:"DATE_CATEGORY_TODAY",reminderLinks:'<a href="#" data-reminder="09:00:00">'+
b("9am")+'</a> <a href="#" data-reminder="12:00:00">'+b("12pm")+'</a> <a href="#" data-reminder="16:00:00">'+b("4pm")+'</a> <a href="#" data-reminder="20:00:00">'+b("8pm")+'</a> <a href="#" class="custom">'+b("date_custom")+"</a>",getDate:w.TODAY,action:function(){p("Gmail","Today");x(o(),"DATE_CATEGORY_TODAY")}},{text:b("date_tomorrow"),category:"DATE_CATEGORY_TOMORROW",reminderLinks:'<a href="#" data-reminder="09:00:00">'+b("9am")+'</a> <a href="#" data-reminder="12:00:00">'+b("12pm")+'</a> <a href="#" data-reminder="16:00:00">'+
b("4pm")+'</a> <a href="#" data-reminder="20:00:00">'+b("8pm")+'</a> <a href="#" class="custom">'+b("date_custom")+"</a>",getDate:w.TOMORROW,action:function(){p("Gmail","Tomorrow");x(o(),"DATE_CATEGORY_TOMORROW")}},{text:b("date_custom"),classNames:"anydo-custom",category:"DATE_CATEGORY_TODAY",getDate:w.TODAY,action:function(){p("Gmail","Custom")}},{text:b("date_someday"),category:"DATE_CATEGORY_SOMEDAY",getDate:w.SOMEDAY,action:function(){p("Gmail","Someday");x(o(),"DATE_CATEGORY_SOMEDAY")}}];(function(){var a=
c(e);a.on("click",B+","+ia,function(a){a.stopPropagation();ja();j.is(".open")?y():j&&(n.addClass(K),a=o(),l.val(a.taskTitle),a=da(),j.addClass("open").css("left",a+"px").show(),l[0].selectionStart=l[0].selectionEnd=0,ca("/gmail-menu"))});a.on("click",f+", .customReminderPicker",function(a){a.stopPropagation()});a.on("click",function(a){y();ja();0==c(a.target).parents(".suggestion-controls").length&&c(".customReminderPicker",e).removeClass("visible")});a.on("hover",B,function(){c(this).toggleClass("T-I-JW")});
a.on("hover",f+" [role=menuitem]",function(){c(this).toggleClass("J-N-JT")});a.on("mouseenter",f+" [role=menuitem]",function(){0==c(this).data("id")&&ka(c(this).find("[data-reminder]"))});a.on("mouseenter",".suggestion-date-category",function(){c(this).next(".reminder-choices-popup").removeClass("invisible");c(this).hasClass("category-today")&&ka(c(this).next().find("[data-reminder]"))});a.on("click",".anydo-open-popup[data-eid="+q+"]",function(){chrome.extension.sendRequest({action:"popupWindow"})});
a.on("click",f+" .anydo-item",function(a){var b=ha[c(this).data("id")],e=b.action;if(""==c.trim(l.val()))l.focus().parent().addClass("invalid");else if(c(a.target).is("[data-reminder]"))a.stopPropagation(),a.preventDefault(),e=c(a.target).attr("data-reminder"),fa(e,b.getDate()),x(o(),h),p("Gmail",b.text,c(a.target).text()),b.keepMenuOpen||y();else if(c(a.target).hasClass("custom")&&p("Gmail",b.text,"Custom"),c(a.target).hasClass("anydo-custom")&&p("Gmail","Custom"),c(a.target).hasClass("anydo-custom")||
c(a.target).hasClass("custom")){s.show();h=b.category;b=b.getDate();O.attr("src",z.replace(/(#.+)?$/,"#"+b));var b=s.width(),e=s.height(),f=-1*b-10;D=j.width();E=j.height();j.css({width:D,height:E}).animate({width:b,height:e},100);C.css("left",0).animate({left:f},200);chrome.extension.sendRequest({action:"trackPageview",track:"/calendarWindow"})}else b.keepMenuOpen||y(),"function"===typeof e&&e.apply(this,arguments)});a.on("keyup",f+" .anydo-input-title",function(){""==c.trim(l.val())?P.addClass("invalid"):
P.removeClass("invalid")});setInterval(ua,300);chrome.extension.onMessage.addListener(function(a){a&&"gmailCalendarPick"==a.type&&(r=a.alert,h=a.dateTime)});a.on("click",f+" .anydo-setReminder",function(a){a.preventDefault();x(o(),h);y()});a.on("click",f+" .anydo-back",function(a){a.preventDefault();C.animate({left:0},200);j.animate({width:D,height:E},200)})})()})(jQuery);