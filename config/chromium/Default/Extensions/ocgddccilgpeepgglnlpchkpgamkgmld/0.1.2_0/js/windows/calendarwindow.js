define(["jquery","underscore","backbone","windows/window","config/user"],function(b,y,j,z,A){var w=[getMessage("January"),getMessage("February"),getMessage("March"),getMessage("April"),getMessage("May"),getMessage("June"),getMessage("July"),getMessage("August"),getMessage("September"),getMessage("October"),getMessage("November"),getMessage("December")],j=getMessage("i_sun"),o=getMessage("i_mon"),p=getMessage("i_tue"),q=getMessage("i_wed"),r=getMessage("i_thu"),s=getMessage("i_fri"),t=getMessage("i_sat"),
B=[t,j,o,p,q,r,s],x=[j,o,p,q,r,s,t],C=[o,p,q,r,s,t,j];console.log(w,x);var k="01,02,03,04,05,06,07,08,09,10,11,12".split(","),n="00,05,10,15,20,25,30,35,40,45,50,55".split(","),g=[31,28,31,30,31,30,31,31,30,31,30,31],u=[[getMessage("off"),"Off"],[getMessage("on_time"),"0"]],v=[["once","TASK_REPEAT_OFF"],["once a Day","TASK_REPEAT_DAY"],["once a Week","TASK_REPEAT_WEEK"],["once a Month","TASK_REPEAT_MONTH"]];return z.extend({className:"window calendar-window",events:{"click .prev":"backOneMonth","click .next":"forwardOneMonth",
"click .current-month":"selectDay","change .time-select":"updateTime","change .alert-select":"updateAlert","change .repeat-select":"updateRepeat","click .back":"setAndClose",transitionEnd:"transitionEnd",webkitTransitionEnd:"transitionEnd"},track:function(){chrome.extension.sendRequest({action:"track",track:arguments})},initialize:function(){y.bindAll(this,"close","show","hide","updateAlert","updateTime","setInitialDate");this.callback=this.options.callback;this.alert=this.options.alert;this.trackClick=
this.options.app?this.options.app.trackClick:this.track;window.onhashchange=this.hashChange.bind(this);this.userConfig=this.options.app?this.options.app.userConfig:new A;this.setInitialDate()},setInitialDate:function(){var a=+location.hash.split("&")[0].slice(1)||this.options.date;a&&(a=new Date(a));if(isNaN(a)||864E5>a)a=null;if((this.date=a)&&this.alert&&this.alert.offset&&"0"!=this.alert.offset)this.date.setMinutes(this.date.getMinutes()-this.alert.offset),this.alert.offset=0;if(this.date&&this.date-
(this.alert?this.alert.offset:0)<+new Date)this.date=null,this.alert={offset:0};this.repeatingMethod=this.options.repeatingMethod;this.date||(this.date=new Date,this.date.setHours(this.date.getHours()+1),this.date.setMinutes(0),this.date.setSeconds(0),console.log("%c Setting due date to default","font-weight: bold;",this.date))},render:function(){b(this.el).empty();this.calendarHeaderTitle=b("<h3>");this.options.chromeless?b(this.el).addClass("chromeless").append(b("<h1>").text(chrome.i18n.getMessage("reminder_window_title"))):
(this.buildHeader(),b(this.el).append(b("<h1>").text(chrome.i18n.getMessage("reminder_window_title"))),b(this.el).append(this.calendarHeaderTitle));this.options.inAnybar&&b(this.el).addClass("anybar");this.buildCalendarTable();this.buildCalendarTimeSelector();this.buildError();this.buildCalendarAlertSelector();this.update();this.updateTime();this.updateAlert("skipReport");return this},hashChange:function(){this.initialize();this.render()},backOneYear:function(){this.trackClick("Calendar Window","Back One Year");
this.date.setFullYear(this.date.getFullYear()-1);this.update()},forwardOneYear:function(){this.trackClick("Calendar Window","Forward One Year");this.date.setFullYear(this.date.getFullYear()+1);this.update()},backOneMonth:function(){this.trackClick("Calendar Window","Back One Month");var a=this.date.getMonth(),b=this.date.getFullYear();0<a?a-=1:(a=11,b-=1);this.date.getDate()>g[a]&&this.date.setDate(g[a]);this.date.setMonth(a);this.date.setFullYear(b);this.update()},forwardOneMonth:function(){this.trackClick("Calendar Window",
"Forward One Month");var a=this.date.getMonth(),b=this.date.getFullYear();11>a?a+=1:(a=0,b+=1);this.date.getDate()>g[a]&&this.date.setDate(g[a]);this.date.setMonth(a);this.date.setFullYear(b);this.update()},updateModel:function(){this.callback({date:this.date,alert:this.alert,repeatingMethod:this.repeatingMethod})},setAndClose:function(){this.updateModel();this.close()},transitionEnd:function(){this.closing&&this.remove()},close:function(){this.closing=!0;this.hide();messageBackgroundPage({type:"startPollingServer"})},
selectDay:function(a){this.trackClick("Calendar Window","Select Day");this.date.setDate(b(a.target).text());this.updateCalendarDateText();this.calendarTable.find("td.current-month.selected").removeClass("selected");b(a.target).addClass("selected");this.options.callback&&this.options.callback({date:this.date,alert:this.alert})},getDaysInMonth:function(a,b){return 1==a&&0==b%4&&(0!=b%100||0==b%400)?29:g[a]},buildHeader:function(){b(this.el).append(b("<header>").append(b("<div>").addClass("back")))},
buildCalendarTable:function(){this.calendarTable=b("<table>");var a=b("<thead>");this.calendarTable.append(a);this.calendarTextLabel=b("<td>").addClass("calendar-date").attr("colspan",3);var c=b("<tr>").appendTo(a);c.append(b("<td>").addClass("calendar-control").addClass("prev").attr("colspan",2));c.append(this.calendarTextLabel);c.append(b("<td>").addClass("calendar-control").addClass("next").attr("colspan",2));for(var a=b("<tr>").appendTo(a),c=this.userConfig.getCalendarDay(),d=0;7>d;d++)1==c?a.append(b("<th>").text(x[d])):
2==c?a.append(b("<th>").text(C[d])):7==c&&a.append(b("<th>").text(B[d]));b(this.el).append(this.calendarTable)},buildCalendarTimeSelector:function(){var a=this.date.getHours()%12,c=parseInt(this.date.getHours()/12),d=5*Math.ceil(this.date.getMinutes()/5),e=b("<div>").addClass("calendar-time");this.timeSelector=e;e.append(b("<span>").text(chrome.i18n.getMessage("alert_when")));this.hourSelect=b("<select>").addClass("time-select");this.minuteSelect=b("<select>").addClass("time-select");this.amPmSelect=
b("<select>").addClass("time-select");for(var l in k){var h=b("<option>").text(k[l]).val(k[l]);this.hourSelect.append(h);k[l]==a&&h.attr("selected","selected")}0==a&&this.hourSelect.val(12);for(var f in n)a=b("<option>").text(n[f]).val(n[f]),this.minuteSelect.append(a),n[f]==d&&a.attr("selected","selected");this.amPmSelect.append(b("<option>").text("AM").val(0));this.amPmSelect.append(b("<option>").text("PM").val(1));b(this.amPmSelect.children().get(c)).attr("selected","selected");e.append(this.hourSelect);
e.append(b("<span>").text(":"));e.append(this.minuteSelect);e.append(this.amPmSelect);b(this.el).append(e)},buildError:function(){var a=b("<div>").addClass("calendar-error");a.append(getMessage("warning_alert_past"));this.$error=b(a).appendTo(this.timeSelector)},buildCalendarAlertSelector:function(){var a=b("<div>").addClass("calendar-option");a.append(b("<img>").attr("src","images/alert_bell_idle.png"));a.append(b("<span>").text(getMessage("reminder")));var c=b("<select>").addClass("alert-select"),
d;for(d in u){var e=u[d],e=b("<option>").text(e[0]).val(e[1]);this.alert&&this.alert.offset==u[d][1]&&e.attr("selected","selected");c.append(e)}"Off"==c.val()&&(c.val("0"),this.alert={type:"OFFSET",offset:0});a.append(c);b(this.el).append(a)},buildCalendarRepeatSelector:function(){var a=b("<div>").addClass("calendar-option");a.append(b("<img>").attr("src","images/alert_repeat.png"));a.append(b("<span>").text("Repeat"));var c=b("<select>").addClass("repeat-select"),d;for(d in v){var e=v[d],e=b("<option>").text(e[0]).val(e[1]);
c.append(e);v[d][1]==this.repeatingMethod&&e.attr("selected","selected")}a.append(c);b(this.el).append(a)},updateTime:function(){this.date.setHours(12*parseInt(this.amPmSelect.val())+parseInt(this.hourSelect.val()%12));this.date.setMinutes(parseInt(this.minuteSelect.val()));this.disallowAlertsInThePast();this.options.callback&&this.options.callback({date:this.date,alert:this.alert})},disallowAlertsInThePast:function(){this.isInThePast()?(this.alert={type:"NONE"},this.timeSelector.addClass("error")):
(this.timeSelector.removeClass("error"),this.updateAlert("skipReport"))},isInThePast:function(){var a=this.alert;if(a)return this.date-(isNaN(a.offset)?0:a.offset)<+new Date?!0:!1},updateAlert:function(a){"skipReport"!=a&&this.trackClick("Calendar Window","Update Alert");this.alert={type:"Off"==b(".alert-select").val()?"NONE":"OFFSET",offset:parseInt(b(".alert-select").val(),10)};this.options.callback&&this.options.callback({date:this.date,alert:this.alert})},updateRepeat:function(a){this.trackClick("Calendar Window",
"Update Repeat");this.repeatingMethod=b(a.target).val()},updateCalendarDateText:function(){var a=new Date;this.calendarTextLabel.text(this.date.getDate()==a.getDate()&&this.date.getMonth()==a.getMonth()&&this.date.getFullYear()==a.getFullYear()?"Today":this.date.toDateString())},update:function(){this.updateCalendarDateText();var a=this.date.getFullYear(),c=this.date.getMonth(),d=new Date,e=d.getDate(),l=d.getFullYear(),d=d.getMonth(),h=new Date(a,c,1),f=h.getDay(),g=0==c?11:c-1,g=this.getDaysInMonth(g,
11==g?a-1:a),f=0==f&&h?7:f;2==this.userConfig.getCalendarDay()?f=(f+6)%7:7==this.userConfig.getCalendarDay()&&(f=(f+1)%7);h=0;this.calendarHeaderTitle.text(w[c]+" "+a);this.calendarTable.children("tbody").remove();var j=b("<tbody>");this.calendarTable.append(j);for(var k=b("<tr>").appendTo(j),i=0;42>i;i++){var m=b("<td>").appendTo(k);m.removeClass("other-month").removeClass("current-month");i<f?m.addClass("other-month").text(g-f+i+1):i>=f+this.getDaysInMonth(c,a)?(h+=1,m.addClass("other-month").text(h)):
(m.text(i-f+1),i-f+1==this.date.getDate()&&m.addClass("selected"),i-f+1<e&&c==d&&a==l||c<d&&a==l||a<l?m.addClass("other-month"):m.addClass("current-month"));6==i%7&&(k=b("<tr>").appendTo(j))}this.updateTime()}})});