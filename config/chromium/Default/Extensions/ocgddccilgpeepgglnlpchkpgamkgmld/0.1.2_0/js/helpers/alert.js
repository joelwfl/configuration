define(["chrome/helpers","underscore"],function(h,g){var c={alarms:{},prepareReminder:function(a,e){var b=c.tasks._byId[a];if(b){if(b.get("status")==TaskStatus.UNCHECKED){var d=c.nextAlertTime(b);console.log("preparing reminder for",b,"secondsLeft are",d);if(0>d&&-3600<d){delete c.alarms[e];console.log("%c ~~~ POPUP for","background: yellow; font-weight: bold;",e);var d=new Date(b.get("dueDate")),f=(10>d.getHours()?"0":"")+d.getHours()+":"+(10>d.getMinutes()?"0":"")+d.getMinutes(),b={id:b.id,category:c.categories.get(b.get("categoryId")).get("name"),
alertTime:+d,formattedTime:f,title:b.get("title"),linkUrl:b.get("linkUrl")};h.showAlert(b)}else console.log("Ignoring alert with secondsLeft",d)}}else console.warn("No such task",a)},nextAlertTime:function(a){var c=a.get("alert"),b=a.get("dueDate");a.get("status");return!c||"NONE"==c.type?null:(b-c.offset-Date.now())/1E3},checkReminders:function(){$.get("chrome-extension://"+getMessage("@@extension_id")+"/dummy");var a=g.clone(c.alarms);g.each(a,function(a,b){if(a){var d=JSON.parse(b);console.log("Checking alarm",
d,new Date(d.due));c.prepareReminder(d.taskId,b)}})},updateReminder:function(a){var e=a.get("alert");a.get("id");var b=a.get("dueDate"),b=JSON.stringify({taskId:a.id,due:b});if(e&&"OFFSET"==e.type&&a.get("status")==TaskStatus.UNCHECKED){var d=c.tasks._byId[a.id],f=a.get("dueDate")-1E3*e.offset;if(-3600>c.nextAlertTime(a))c.removeAlarm(b);else if("object"==typeof a.attributes?d.set(a.attributes,{silent:!0}):(delete a.get,d.set(a,{silent:!0})),!c.alarms[b])c.alarms[b]=!0,console.log("creating alert",
a,e,"alarm time:",f)}else c.removeAlarm(b)},updateReminders:function(a,e,b){console.log("updateReminders called",b?b:"");c.tasks=e;c.categories=a;a=e.getTopLevelTasks();if(b){b.get=function(a){return b[a]};var d=b.get("id");c.tasks._byId[d]?c.updateReminder(b):console.warn("Sorry, didn't found this task",d)}else for(d in a)c.updateReminder(a[d])},removeAlarm:function(a){c.alarms[a]&&delete c.alarms[a]}};return c});